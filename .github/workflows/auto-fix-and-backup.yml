# .github/workflows/auto-fix-and-backup.yml
name: ðŸ”§ Auto-Fix & Backup Before Release
on:
  push:
    branches: [main, master]
  pull_request:
    types: [opened, synchronize]

jobs:
  analyze-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Create Automatic Backup Branch
        run: |
          BACKUP_NUM=1
          while git ls-remote --heads origin BackUp${BACKUP_NUM} 2>/dev/null | grep -q .; do
            BACKUP_NUM=$((BACKUP_NUM + 1))
          done
          BACKUP_BRANCH="BackUp${BACKUP_NUM}"
          echo "BACKUP_BRANCH=${BACKUP_BRANCH}" >> $GITHUB_ENV
          git checkout -b ${BACKUP_BRANCH}
          git push origin ${BACKUP_BRANCH}
          echo "âœ… Created backup branch: ${BACKUP_BRANCH}"

      - name: ðŸ› Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Install Dependencies
        run: |
          if [ -f "package.json" ]; then
            if [ -f "package-lock.json" ]; then
              npm ci --silent
            else
              npm install --silent
            fi
          fi

      # ==========================================================================
      # ðŸš€ INSTANT MAINTENANCE MODE USING EDGE CONFIG (NO REDEPLOY)
      # ==========================================================================
      - name: ðŸ”§ Enable Maintenance Mode (INSTANT - Edge Config)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "ðŸ› ï¸ Enabling maintenance mode instantly via Edge Config..."
          
          # ðŸ”¥ YOUR EDGE CONFIG ID (hardcoded)
          EDGE_CONFIG_ID="ecfg_iseyjgzxjxubbehh6at0yf7qw4gs"
          
          # Update the value to true
          RESPONSE=$(curl -s -X PATCH \
            -H "Authorization: Bearer ${VERCEL_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.vercel.com/v1/edge-config/${EDGE_CONFIG_ID}/items" \
            -d '{
              "items": [
                {
                  "operation": "upsert",
                  "key": "enabled",
                  "value": true
                }
              ]
            }')
          
          # âœ… Vercel Edge Config API returns {"status":"ok"} on success
          if echo "$RESPONSE" | grep -q '"status":"ok"'; then
            echo "âœ… Maintenance mode is NOW ACTIVE (instant, no redeploy)"
          else
            echo "âŒ Failed to enable maintenance mode"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: ðŸ› Run ESLint Auto-Fix
        run: |
          if [ -f "package.json" ]; then
            if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f ".eslintrc" ] || [ -f ".eslintrc.yml" ]; then
              npx eslint --fix . || true
              echo "âœ… ESLint fixes attempted"
            else
              echo "âš ï¸ No ESLint config found, creating default..."
              printf '{\n  "extends": "next/core-web-vitals",\n  "rules": {\n    "no-console": "warn",\n    "no-debugger": "error",\n    "no-unused-vars": "warn"\n  }\n}\n' > .eslintrc.json
              npx eslint --fix . || true
              echo "âœ… ESLint ran with default config"
            fi
          fi

      - name: ðŸ” Run Prettier Auto-Format
        run: |
          if [ -f "package.json" ]; then
            if grep -q "prettier" package.json; then
              npx prettier --write "**/*.{js,jsx,ts,tsx,json,css,md}" || true
              echo "âœ… Prettier formatting complete"
            else
              echo "âš ï¸ Prettier not found, installing..."
              npm install --save-dev prettier --silent
              npx prettier --write "**/*.{js,jsx,ts,tsx,json,css,md}" || true
              echo "âœ… Prettier formatting complete"
            fi
          fi

      - name: ðŸ•·ï¸ Run TypeScript Checks
        run: |
          if [ -f "tsconfig.json" ]; then
            npm install typescript --save-dev --silent
            npx tsc --noEmit || echo "âš ï¸ TypeScript errors exist - manual review needed"
          else
            echo "ðŸ“˜ No TypeScript config found, skipping"
          fi

      - name: ðŸŒ³ Check for Security Vulnerabilities
        run: |
          if [ -f "package.json" ]; then
            npm audit fix || npm audit fix --force || echo "âš ï¸ Some vulnerabilities require manual fix"
          fi

      - name: ðŸ§¹ Remove Console.logs and Debuggers
        run: |
          FILES=$(find . -type f \( -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" \) \
            -not -path "./node_modules/*" \
            -not -path "./.git/*" \
            -not -path "./dist/*" \
            -not -path "./build/*" \
            -not -path "./.next/*" 2>/dev/null || true)
          
          if [ -n "$FILES" ]; then
            echo "$FILES" | xargs sed -i 's/console\.log(.*);//g' 2>/dev/null || true
            echo "$FILES" | xargs sed -i 's/debugger;//g' 2>/dev/null || true
            echo "âœ… Console logs and debuggers removed"
          else
            echo "ðŸ“ No JavaScript/TypeScript files found"
          fi

      - name: ðŸ’¾ Commit Auto-Fixes
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          git config user.name "Quantum Auto-Fix Bot"
          git config user.email "fix-bot@quantum-modz.ai"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ðŸ¤– Auto-fix: ESLint, Prettier, console cleanup"
            
            if git push origin HEAD:${GITHUB_REF_NAME}; then
              echo "FIXES_APPLIED=true" >> $GITHUB_ENV
              echo "âœ… Auto-fixes committed and pushed"
            else
              git pull --rebase origin ${GITHUB_REF_NAME} || true
              git push origin HEAD:${GITHUB_REF_NAME} || true
              echo "FIXES_APPLIED=true" >> $GITHUB_ENV
              echo "âœ… Auto-fixes committed and pushed (with rebase)"
            fi
          else
            echo "FIXES_APPLIED=false" >> $GITHUB_ENV
            echo "âœ… No fixes needed"
          fi

      - name: ðŸš€ Trigger Vercel Deploy Hook
        if: env.FIXES_APPLIED == 'true'
        env:
          DEPLOY_HOOK_URL: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}
        run: |
          echo "ðŸš€ Triggering Vercel deploy hook to deploy fixes..."
          curl -X POST -sSf "${DEPLOY_HOOK_URL}" || {
            echo "âŒ Deploy hook failed"
            exit 1
          }
          echo "âœ… Vercel deploy hook triggered successfully"

      - name: ðŸ”§ Disable Maintenance Mode (INSTANT - Edge Config)
        if: always()
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "ðŸ› ï¸ Disabling maintenance mode instantly via Edge Config..."
          
          # ðŸ”¥ YOUR EDGE CONFIG ID (hardcoded)
          EDGE_CONFIG_ID="ecfg_iseyjgzxjxubbehh6at0yf7qw4gs"
          
          # Update the value to false
          RESPONSE=$(curl -s -X PATCH \
            -H "Authorization: Bearer ${VERCEL_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.vercel.com/v1/edge-config/${EDGE_CONFIG_ID}/items" \
            -d '{
              "items": [
                {
                  "operation": "upsert",
                  "key": "enabled",
                  "value": false
                }
              ]
            }')
          
          # âœ… Vercel Edge Config API returns {"status":"ok"} on success
          if echo "$RESPONSE" | grep -q '"status":"ok"'; then
            echo "âœ… Maintenance mode is NOW INACTIVE (instant, no redeploy)"
          else
            echo "âŒ Failed to disable maintenance mode"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: ðŸ“ Generate Fix Report
        if: always()
        env:
          BACKUP_BRANCH: ${{ env.BACKUP_BRANCH }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          GITHUB_ACTOR: ${{ github.actor }}
          FIXES_APPLIED: ${{ env.FIXES_APPLIED }}
        run: |
          COMMIT_SHORT=$(echo "${GITHUB_SHA}" | cut -c1-7)
          cat > fix-report.md <<-EOF
          # ðŸ¤– Automatic Code Fix Report
          
          **Repository:** ${GITHUB_REPOSITORY}
          **Backup Branch:** \`${BACKUP_BRANCH}\`
          **Commit:** \`${COMMIT_SHORT}\`
          **Workflow:** ${GITHUB_WORKFLOW}
          **Triggered by:** ${GITHUB_ACTOR}
          **Timestamp:** $(date -u)
          
          ## âœ… Changes Applied
          - Created backup branch: \`${BACKUP_BRANCH}\`
          - âœ… **INSTANT MAINTENANCE MODE ENABLED** (Edge Config)
          - Ran ESLint auto-fix
          - Formatted code with Prettier
          - Removed console.log statements
          - Removed debugger statements
          - Attempted TypeScript fixes
          - Ran security audit fixes
          - âœ… **INSTANT MAINTENANCE MODE DISABLED** (Edge Config)
          
          ## ðŸ“Š Summary
          - **Status:** âœ… Complete
          - **Fixes Applied:** ${FIXES_APPLIED:-false}
          - **Backup:** [View Branch](https://github.com/${GITHUB_REPOSITORY}/tree/${BACKUP_BRANCH})
          - **Maintenance Mode:** Instant toggle via Edge Config (no redeploy)
          
          ## ðŸš€ Next Steps
          Vercel deployment triggered via deploy hook. Site will update with fixes in 1-2 minutes.
          Maintenance mode was **INSTANTLY** active during the fix process.
          
          *To revert to original code:*
          \`\`\`bash
          git checkout ${BACKUP_BRANCH}
          git checkout -b restore-\$(date +%Y%m%d)
          \`\`\`
          EOF

      - name: ðŸ“¢ Post Status to GitHub
        env:
          BACKUP_BRANCH: ${{ env.BACKUP_BRANCH }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          FIXES_APPLIED: ${{ env.FIXES_APPLIED }}
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
            -d '{
              "state": "success",
              "target_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "description": "âœ… Auto-fix complete - Backup: '"${BACKUP_BRANCH}"'",
              "context": "quantum/auto-fix"
            }'
          
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
              -d '{
                "body": "ðŸ¤– **Quantum Auto-Fix Complete**\n\nâœ… Backup branch: `'"${BACKUP_BRANCH}"'`\nðŸ”§ Fixes applied: `'"${FIXES_APPLIED}"'`\nâš¡ **Maintenance mode toggled INSTANTLY via Edge Config**\nðŸš€ Vercel deploy hook triggered\nðŸ“Š [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n*This comment was automatically posted by the Quantum Auto-Fix Bot*"
              }'
          fi

      - name: ðŸ“Š Upload Fix Report
        uses: actions/upload-artifact@v4
        with:
          name: fix-report-${{ github.sha }}
          path: fix-report.md
          retention-days: 30
